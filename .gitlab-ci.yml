image: node:19

stages:
    - build
    - test
    - sonar

cache:
    paths:
        - node_modules/

variables:
  # to be defined in specific pipeline
  coverage_dir: "$CI_PROJECT_DIR/coverage"
  coverage_path: "$coverage_dir/lcov.info"


build:
    stage: build
    script:
        - npm ci
        - npm run build
    tags:
        - nlp-runner

test:
    stage: test
    script:
        - npm ci
        - npx jest --coverage --coverageDirectory=$coverage_dir
    tags:
        - nlp-runner
    artifacts:
        paths:
            - $coverage_dir


sonar:
    stage: sonar
    allow_failure: true
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [ "" ]
    script:
        - sonar-scanner -h
        - sonar-scanner -D sonar.projectKey=$SONAR_PROJECT_KEY
                        -D sonar.host.url=$SONAR_URL
                        -D sonar.login=$SONAR_TOKEN
                        -D sonar.sources='.'
                        -D sonar.exclusions='**/*.spec.ts,**/*.test.ts,**/*.vue,**/coverage/**,**/*.config.js'
                        -D sonar.javascript.lcov.reportPaths=$coverage_path
    tags:
        - nlp-runner

